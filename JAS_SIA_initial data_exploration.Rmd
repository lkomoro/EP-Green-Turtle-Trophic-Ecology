---
title: 'Seminoff EPac green turtle Stable Isotope Data Analysis'
author: "Lisa Komoroske"
date: '`r Sys.Date()`'
output: word_document
---
##Metadata from Jeff
**Site** - an ordinal code for each site  
**Site code** - 3 letter code for each site  
**Ordered_SITE** - combined site code with ordered # roughly North to South for graphing ordering
**Location_Label** - shortened locatin names for graphing labeling purposes
**Location** - location of turtle capture  
**LAB ID** - self explanatory  
**Collection Date** - self explanatory  
**Run Date** - self explanatory  
**%N** - elemental concentration of N.  that is, how much each sample is made up of nitrogen.  this is used as a diagnostic to know sample quality (anything outside of ~9-17% N raises a red flag)  
**%C** - elemental concentration of C.  that is, how much each sample is made up of carbon.  this is used as a diagnostic to know sample quality (anything outside of ~40-60% C raises a red flag)  
**d15N** - stable isotope value for N  
**d13C** - stable isotope value for C  
**Color** - rarely filled in. This is largely for the Galapagos and Colombia, where black turtles (eastern Pacific stock) and yellow turtles (west Pacific origins) co-exist.  Safe to say that anything that is not filled in here would be a ‘black’ morph.  
**SCL** - straight carapace length 
**CCL_calc_fromSCL** - used formula from Seminoff et al. 2003 to interpolate CCLs from SCLs
**CCL_empirical** - curved carapace length-these are only the empirically collected values
**CCL_combined** - curved carapace length-I pasted over all the empirical values, and then for ones that were missing empirical CCL but had **CCL_calc_fromSCL**, I added these in; so this is the combined variable that we'll use for size relationships


##Setup
```{r setup, echo=FALSE,include=FALSE}
setwd("~/Dropbox/KomoCheng/Seminoff_isotope_MS_transitionfiles")
getwd()
```

##Load Required Libraries
```{r libraries, echo=FALSE, include=FALSE}
library(ggplot2)
library(plyr)
library(RColorBrewer)#can also use palettes, etc. l=defines darkness/lightness of colors see R graphics cookbook pgs255-263
#additional code and plots from Latimer class for data QC and exploration:####
library(MASS); library(lattice)
library(lme4); library(lmerTest)
```

##Read in data
```{r read_data, echo=FALSE,include=FALSE}
data<-read.csv("CM Isotope Data UPDATED.csv")
data$Ordered_SITE<-factor(data$Ordered_SITE, levels =c("1-SGR_SBN","3-SDB", 
"4-ESC","5-LSI", "6-BMA","7-IPD","8-LOR","9-BLA","11-CIN","13-DUL","14-PAR","15-MEJ",
"16-ISL","17-COC","18-GOR","19-IGP","20-IGE","21-IGD","22-IGZ","23-IGN","24-PPE"))

#12-19-16 added: removing problematic sites
data_new<-subset(data, Ordered_SITE!="7-IPD" &Ordered_SITE!="8-LOR"&Ordered_SITE!="16-ISL"&Ordered_SITE!="22-IGZ"&Ordered_SITE!="23-IGN")
data_new<-subset(data_new, Percent_N>=4 | is.na(data_new$Percent_N) )
data_new$Collect_Date <- strptime(data_new$Collect_Date, "%m/%d/%Y")
data_new$Run_Date <- strptime(data_new$Run_Date, "%m/%d/%Y")
palette<-c("firebrick","forestgreen","blue4","purple","orange")
data_new2<-subset(data_new,Habitat_Type!="oceanic") #exclude oceanic site
data<-data_new
#updated 12-20-16 summary files reading in here to reflect new groupings, excluded data etc.
#Create summary df's: (note that running the strptime function below screws this up, so need to create these summary DF's first)
# d15N.sumc <- ddply(data, c("Ordered_SITE","Habitat_Type"), summarise,
#                N    = length(d15N),
#                mean = mean(d15N),
#                sd   = sd(d15N),
#                se   = sd / sqrt(N)
# )
# 
# d13C.sumc <- ddply(data, c("Ordered_SITE","Habitat_Type"), summarise,
#                N    = length(d13C),
#                mean = mean(d13C),
#                sd   = sd(d13C),
#                se   = sd / sqrt(N)
# )
# # 
# # #write out summary data to add N-S order
# #write.csv(d15N.sumc, paste(file = "EPGT_d15Nsumc.csv", sep=""), row.names = FALSE)
# write.csv(d13C.sumc , paste(file = "EPGT_d13Csumc.csv", sep=""), row.names = FALSE)

data_Nsum<-read.csv("EPGT_d15Nsumc_LKedit.csv")
str(data_Nsum) 
data_Csum<-read.csv("EPGT_d13Csumc_LKedit.csv")
str(data_Csum)
```

##Coarse data QC checks to note obvious data structure problems, etc.:
```{r initial_QC, echo=TRUE}
#see version 1 for more in depth QC checks
summary(data)
data$Ordered_SITE<-factor(data$Ordered_SITE)#reset variable to get rid of excluded sites in count
table(data$Ordered_SITE) #frequency table
```
Laguna San Ignacio now only one with lower sample #s-confirm with Jeff keeping/seperate with Estero Coyote

##Data Exploration for delta C and N  
*Ggplot univariate & bivariate graphic scans etc*
####1. Nitrogen
```{r data_exploration-dN, echo=TRUE}
#Distributions:
ggplot(data, aes(x=d15N)) + 
  geom_histogram(aes(y=..density..),      # Histogram with density on y-axis
                 binwidth=.5,
                 colour="black", fill="dodgerblue") +
  geom_density(alpha=.4, fill="yellow")+theme_bw()+
geom_vline(aes(xintercept=mean(d15N, na.rm=T)),    #Ignore NA values for mean
           color="red", linetype="dashed", size=1)

#histograms only, faceted:
a<-ggplot(data, aes(x=d15N)) + geom_histogram(alpha=.75, fill="blue",colour="black")+theme_bw()+
geom_vline(aes(xintercept=mean(d15N, na.rm=T)),    #Ignore NA values for mean
           color="red", linetype="dashed", size=1)
a+facet_wrap( ~ Location_Label, ncol=4)

#Boxplot, ordering by medians
ggplot(data, aes(x=Ordered_SITE, y=d15N,fill=Region)) + geom_boxplot(alpha=0.9) +theme_bw()+xlab("Location (ordered by value)")+scale_fill_manual(values=palette)+
  guides(fill=FALSE)+stat_summary(fun.y=mean, geom="point", shape=5, size=4)+theme(axis.text.x  = element_text(angle=90, vjust=0.5))+coord_flip()

#faceted mean dot
ggplot(data_Nsum, aes(y=reorder(Ordered_SITE,N_to_S_ordination), x=mean_d15N, fill=Region)) + 
  geom_errorbarh(aes(xmin=mean_d15N-se_d15N,xmax=mean_d15N+se_d15N),size=0.25)+
  geom_point(size=3, aes(colour=Region)) +theme_bw()+ guides(fill=FALSE)+
  theme(panel.grid.major.x=element_blank(),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.y=element_line(colour="grey60",linetype="dashed"))+ scale_colour_manual(values=palette,guide=FALSE)+
  ylab("Location (N to S)") +xlab("Mean d15N") +
  facet_grid(Region~.,scales="free_y",space="free_y")
```

####Carbon
```{r data_exploration-dC, echo=TRUE}
#Distributions:
ggplot(data, aes(x=d13C)) + 
  geom_histogram(aes(y=..density..),      # Histogram with density on y-axis
                 binwidth=.5,
                 colour="black", fill="dodgerblue") +
  geom_density(alpha=.4, fill="yellow")+theme_bw()+
geom_vline(aes(xintercept=mean(d13C, na.rm=T)),    #Ignore NA values for mean
           color="red", linetype="dashed", size=1)

#histograms only, faceted:
a<-ggplot(data, aes(x=d13C)) + geom_histogram(alpha=.75, fill="blue",colour="black")+theme_bw()+
geom_vline(aes(xintercept=mean(d13C, na.rm=T)),    #Ignore NA values for mean
           color="red", linetype="dashed", size=1)
a+facet_wrap( ~ Location_Label, ncol=4)

#Boxplot, ordering by medians
ggplot(data, aes(x=Ordered_SITE, y=d13C, fill=Region)) + geom_boxplot(alpha=0.9) +theme_bw()+xlab("Location (ordered by value)")+scale_fill_manual(values=palette)+
  guides(fill=FALSE)+stat_summary(fun.y=mean, geom="point", shape=5, size=4)+theme(axis.text.x  = element_text(angle=90, vjust=0.5))+coord_flip()

#faceted mean dot
ggplot(data_Csum, aes(y=reorder(Ordered_SITE,N_to_S_ordination), x=mean_d13C, fill=Region)) + 
  geom_errorbarh(aes(xmin=mean_d13C-se_d13C,xmax=mean_d13C+se_d13C),size=0.25)+
  geom_point(size=3, aes(colour=Region)) +theme_bw()+ guides(fill=FALSE)+
  theme(panel.grid.major.x=element_blank(),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.y=element_line(colour="grey60",linetype="dashed"))+ scale_colour_manual(values=palette,guide=FALSE)+
  ylab("Location (N to S)") +xlab("Mean d13C") +
  facet_grid(Region~.,scales="free_y",space="free_y")
```
  
####Relationships Turtle Size or Color  
```{r SI_size, echo=TRUE}
#use CCL_combined

#issue of big turtles at certain sites?
ggplot(data, aes(x=Ordered_SITE,y=CCL_combined,fill=Region)) + geom_boxplot()+theme_bw()+theme(axis.text.x  = element_text(angle=50, vjust=0.5))+scale_fill_manual(values=palette)

ggplot(data, aes(x=Ordered_SITE,y=CCL_combined,fill=Region)) + geom_boxplot()+theme_bw()+theme(axis.text.x  = element_text(angle=50, vjust=0.5))+scale_fill_manual(values=palette)+facet_grid(Region~.)

#Size vs. Nitrogen
p<-ggplot(data, aes(x=CCL_combined,y=d15N,fill=Region)) + geom_point(size=3, alpha=.8,shape=21,position=position_jitter(width=.5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=90, vjust=0.5))+scale_fill_manual(values=palette)
p+geom_smooth(method=lm)

s<-ggplot(data, aes(x=CCL_combined,y=d15N,fill=Ordered_SITE)) + geom_point(size=3, alpha=.8,shape=21,position=position_jitter(width=.5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=90, vjust=0.5))+facet_wrap( ~ Ordered_SITE, ncol=4)
s+geom_smooth(method=lm)

t<-ggplot(data, aes(x=CCL_combined,y=d15N,fill=Ordered_SITE)) + geom_point(size=3, alpha=.8,shape=21,position=position_jitter(width=.5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=90, vjust=0.5))+facet_wrap( ~ Region, ncol=3)
t+geom_smooth(method=lm)

#Size vs. Carbon
p1<-ggplot(data, aes(x=CCL_combined,y=d13C,fill=Region)) + geom_point(size=3, alpha=.8,shape=21,position=position_jitter(width=.5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=90, vjust=0.5))+scale_fill_manual(values=palette)
p1+geom_smooth(method=lm)

s1<-ggplot(data, aes(x=CCL_combined,y=d13C,fill=Ordered_SITE)) + geom_point(size=3, alpha=.8,shape=21,position=position_jitter(width=.5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=90, vjust=0.5))+facet_wrap( ~ Ordered_SITE, ncol=4)
s1+geom_smooth(method=lm)

t1<-ggplot(data, aes(x=CCL_combined,y=d13C,fill=Ordered_SITE)) + geom_point(size=3, alpha=.8,shape=21,position=position_jitter(width=.5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=90, vjust=0.5))+facet_wrap( ~ Region, ncol=3)
t1+geom_smooth(method=lm)

m1<-lm(data=data, d15N~CCL_combined*Ordered_SITE)
summary(m1)
library(car)
Anova(m1)
plot(m1)

m2<-lm(data=data, d13C~CCL_combined*Ordered_SITE)
summary(m2)
Anova(m2)
plot(m2)
#remember to come back and remove point to see if makes difference in weight of sign. at BMA


BMA<-subset(data, SITE_CODE=="BMA")
BMA<-subset(BMA, d15N<=15)
BMA_m<-lm(data=BMA, d15N~CCL_combined)

summary(BMA_m)
ggplot(BMA, aes(x=CCL_combined,y=d15N)) + geom_point(size=3, alpha=.8,shape=21,position=position_jitter(width=.5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=90, vjust=0.5))+geom_smooth(method=lm)
```

```{r CvsN, echo=TRUE}
ggplot(data_new2, aes(x=d15N,y=d13C,fill=Location_Label)) + geom_point(size=3, alpha=.8,shape=21,position=position_jitter(width=.5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=0, vjust=0.5))+facet_wrap( ~ Region, ncol=2)#excluding oceanic/longline turtles

ggplot(data, aes(x=d15N,y=d13C,fill=Region)) + geom_point(size=3, alpha=.8,shape=21,position=position_jitter(width=.5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=0, vjust=0.5))+scale_fill_manual(values=palette)

CNsum_merge<-merge(data_Csum,data_Nsum)
CNsum_merge$SITENS<-paste(CNsum_merge$N_to_S_ordination, "-",CNsum_merge$Ordered_SITE)
CNsum_merge$SITENS
CNsum_merge$SITENS<-factor(CNsum_merge$SITENS,levels= c("1 - MEJ","2 - PAR","3 - PPE" ,"6 - IGD",
"7 - IGE","8 - IGP","9 - GOR", "10 - COC", "11 - DUL","13 - BMA", "16 - LSI" ,"17 - ESC","18 - CIN","19 - BLA",
"20 - SDB","21 - SGR_SBN"))   

ggplot(CNsum_merge, aes(x=mean_d13C,y=mean_d15N,fill=Region)) +
  geom_errorbar(aes(ymin=mean_d15N-se_d15N,ymax=mean_d15N+se_d15N),size=0.25)+
  geom_errorbarh(aes(xmin=mean_d13C-se_d13C,xmax=mean_d13C+se_d13C),size=0.25)+
  geom_point(size=3, alpha=.9,shape=21)+theme_bw()+theme(axis.text.x  = element_text(angle=0, vjust=0.5))+scale_fill_manual(values=palette)+ylab("Mean d15N per Location")+xlab("Mean d13C per Location")

ggplot(CNsum_merge, aes(x=mean_d13C,y=mean_d15N,fill=SITENS)) +
  geom_errorbar(aes(ymin=mean_d15N-se_d15N,ymax=mean_d15N+se_d15N),size=0.25)+
  geom_errorbarh(aes(xmin=mean_d13C-se_d13C,xmax=mean_d13C+se_d13C),size=0.25)+
  geom_point(size=3, alpha=.9,shape=21)+theme_bw()+theme(axis.text.x  = element_text(angle=0, vjust=0.5))+ylab("Mean d15N per Location")+xlab("Mean d13C per Location")

ggplot(CNsum_merge, aes(x=mean_d13C,y=mean_d15N,fill=SITENS)) +
  geom_errorbar(aes(ymin=mean_d15N-se_d15N,ymax=mean_d15N+se_d15N),size=0.25)+
  geom_errorbarh(aes(xmin=mean_d13C-se_d13C,xmax=mean_d13C+se_d13C),size=0.25)+
  geom_point(size=3, alpha=.9,shape=21)+theme_bw()+theme(axis.text.x  = element_text(angle=0, vjust=0.5))+ylab("Mean d15N per Location")+xlab("Mean d13C per Location")+geom_text(aes(label=Ordered_SITE),hjust=1.5, vjust=0.5,size=3)

ggplot(data, aes(x=d13C,y=d15N,fill=Ordered_SITE)) +
  geom_point(size=4.5, alpha=.8,shape=21)+theme_bw()

#come back to if decide worth it
#dataEllipse(data$d13C, data$d15N, data$Ordered_SITE, levels=c(0.95, 0.95), center.pch=19, center.cex=1.5, col=palette2)

```

```{r color_shell, echo=TRUE}
data_color<-subset(data, COLOR=="BLACK" | COLOR=="YELLOW")
ggplot(data_color, aes(x=d15N,y=d13C,fill=COLOR)) + geom_point(aes(size=CCL_combined), alpha=.8,shape=21,position=position_jitter(width=.5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=0, vjust=0.5))+scale_fill_manual(values=palette)

#histogram N
ggplot(data_color, aes(x=d15N, fill=COLOR)) + geom_histogram(alpha=.75, colour="black")+theme_bw()+
geom_vline(aes(xintercept=mean(d15N, na.rm=T)),    #Ignore NA values for mean
           color="red", linetype="dashed", size=1)+scale_fill_manual(values=palette)

#Boxplot N
ggplot(data_color, aes(x=COLOR, y=d15N)) + geom_boxplot(alpha=0.9, fill="skyblue") +theme_bw()+xlab("Morph Type")+scale_fill_manual(values=palette)+
  guides(fill=FALSE)+stat_summary(fun.y=mean, geom="point", shape=5, size=4)+theme(axis.text.x  = element_text(angle=90, vjust=0.5))

#histogram C
ggplot(data_color, aes(x=d13C, fill=COLOR)) + geom_histogram(alpha=.75, colour="black")+theme_bw()+
geom_vline(aes(xintercept=mean(d13C, na.rm=T)),    #Ignore NA values for mean
           color="red", linetype="dashed", size=1)+scale_fill_manual(values=palette)

#Boxplot C
ggplot(data_color, aes(x=COLOR, y=d13C)) + geom_boxplot(alpha=0.9, fill="skyblue") +theme_bw()+xlab("Morph Type")+scale_fill_manual(values=palette)+
  guides(fill=FALSE)+stat_summary(fun.y=mean, geom="point", shape=5, size=4)+theme(axis.text.x  = element_text(angle=90, vjust=0.5))

```

```{r map, echo=TRUE}
#using raster package for biooracle data
library(raster)
#read in raster data
#asc is a file format
quartz(4,4)
sst.mean<-raster("sstmean.asc")
sst.mean #like str for a raster

EPGT_latlong<-read.csv("Lat_long_EPGT.csv")
xy<-cbind(EPGT_latlong$Longitude,EPGT_latlong$Latitude)


EPGT_latlong$mean_d15N_scale<-EPGT_latlong$mean_d15N*0.15
plot(sst.mean,main="East Pacific", col=colorRampPalette(c("blue","purple", "yellow","red"))(255), 
     legend.args=list(text='Degrees C', side=4,font=2, line=2.5, cex=0.8), xlim=c(-152,-58), ylim=c(-50,50))
points(xy, pch=21, cex=EPGT_latlong$mean_d15N_scale, bg="grey90") 


EPGT_latlong$mean_d13C_scale<-EPGT_latlong$mean_d13C*-0.15
plot(sst.mean,main="East Pacific", col=colorRampPalette(c("blue","purple", "yellow","red"))(255), 
     legend.args=list(text='Degrees C', side=4,font=2, line=2.5, cex=0.8), xlim=c(-152,-58), ylim=c(-50,50))
points(xy, pch=21, cex=EPGT_latlong$mean_d13C_scale, bg="grey90") 

#if want to annotate, edit this:
#text(x=-88.5,y=0, labels="Shark Bait")
```

```{r ellipse, echo=TRUE}


```

---
title: 'Seminoff EPac green turtle Stable Isotope Data Analysis'
author: "Lisa Komoroske"
date: '`r Sys.Date()`'
output: word_document
---
##Metadata from Jeff
**Site** - an ordinal code for each site  
**Site code** - 3 letter code for each site  
**Location** - location of turtle capture  
**LAB ID** - self explanatory  
**Collection Date** - self explanatory  
**Run Date** - self explanatory  
**%N** - elemental concentration of N.  that is, how much each sample is made up of nitrogen.  this is used as a diagnostic to know sample quality (anything outside of ~9-17% N raises a red flag)  
**%C** - elemental concentration of C.  that is, how much each sample is made up of carbon.  this is used as a diagnostic to know sample quality (anything outside of ~40-60% C raises a red flag)  
**d15N** - stable isotope value for N  
**d13C** - stable isotope value for C  
**Color** - rarely filled in. This is largely for the Galapagos and Colombia, where black turtles (eastern Pacific stock) and yellow turtles (west pacific origins) co-exist.  Safe to say that anything that is not filled in here would be a ‘black’ morph.  
**SCL** - straight carapace length  
**CCL** - curved carapace length  

##Setup
```{r setup, echo=FALSE,include=FALSE}
setwd("~/Dropbox/KomoCheng/Seminoff_isotope_MS_transitionfiles")
getwd()
```

##Load Required Libraries
```{r libraries, echo=FALSE, include=FALSE}
library(ggplot2)
library(plyr)
library(RColorBrewer)#can also use palettes, etc. l=defines darkness/lightness of colors see R graphics cookbook pgs255-263
#additional code and plots from Latimer class for data QC and exploration:####
library(MASS); library(lattice); library(vioplot)
library(lme4); library(lmerTest)
```

##Read in data
```{r read_data, echo=TRUE,include=FALSE}
data<-read.csv("CM Isotope Data UPDATED.csv")#note this is currently using updated file from Joel 10/27/16 with my edits that include the column edits and habitat type code
#order for graphing habitat type groups together
data$Ordered_SITE<-factor(data$Ordered_SITE, levels =c("1-SGR","2-SBN", "3-SDB", 
"4-ESC","5-LSI", "6-BMA","7-IPD","8-LOR","9-BLA","11-CIN","13-DUL","14-PAR","15-MEJ",
"16-ISL","17-COC","18-GOR","19-IGP","20-IGE","21-IGD","22-IGZ","23-IGN","24-PPE"))

#Create summary df's: (note that running the strptime function below screws this up, so need to create these summary DF's first)
d15N.sumc <- ddply(data, c("Ordered_SITE","Habitat_Type"), summarise,
               N    = length(d15N),
               mean = mean(d15N),
               sd   = sd(d15N),
               se   = sd / sqrt(N)
)

d13C.sumc <- ddply(data, c("Ordered_SITE","Habitat_Type"), summarise,
               N    = length(d13C),
               mean = mean(d13C),
               sd   = sd(d13C),
               se   = sd / sqrt(N)
)

data$Collect_Date <- strptime(data$Collect_Date, "%m/%d/%Y")
data$Run_Date <- strptime(data$Run_Date, "%m/%d/%Y")
palette<-c("firebrick","forestgreen","blue4")
pd<-0.1

#write out summary data to add N-S order
#write.csv(d15N.sumc, paste(file = "EPGT_d15Nsumc.csv", sep=""), row.names = FALSE)
data_Nsum<-read.csv("EPGT_d15Nsumc_LKedit.csv")
str(data_Nsum) 

#write.csv(d13C.sumc , paste(file = "EPGT_d13Csumc.csv", sep=""), row.names = FALSE)
data_Csum<-read.csv("EPGT_d13Csumc_LKedit.csv")
str(data_Csum)

data2<-subset(data,Habitat_Type!="oceanic") #get rid of oceanic site before analysis

```

##Coarse data QC checks to note obvious data structure problems, etc.:
```{r initial_QC, echo=TRUE}
#View(data)
str(data) #all look like appropriate categories
dim(data)
head(data)
tail(data) #got rid of some NAs at end, now should be good
summary(data)


table(data$SITE_CODE,data$Habitat_Type) #frequency table, note some sites have few samples (some 1s and 3s)

#found/fixed issues, but leaving in example code here for if need to find which cases are causing issues:
#summary(dataframe$variable)
#which(dataframe$variable=="value")
#is.na(dataframe$variable), or conversely !is.na(dataframe$variable)
#which(dataframe$variable=="value")
```
*N.B. 87 entries are missing percent N or C, but have the delta N and C-follow up with Jeff/Joel if this is an issue given that these are variables to check sample quality (see metadata above)*  

##SI data specific QC checks  
```{r data_QC, include=TRUE}
#Are all the samples unique/any issues of duplicates?
length(unique(data$LABID))
length(data$LABID)
#all good

summary(data$Collect_Date)
#Any issues with confounding dates of collection or run?
ggplot(data, aes(x=Collect_Date,y=d15N,fill=Habitat_Type)) + geom_point(size=3, alpha=.8,shape=21,position=position_jitter(width=.5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=90, vjust=0.5))+scale_fill_manual(values=palette)

ggplot(data, aes(x=Collect_Date,y=d15N,fill=SITE_CODE)) + geom_point(size=3, alpha=1,shape=21,position=position_jitter(width=5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=90, vjust=0.5))

ggplot(data, aes(x=Run_Date,y=d15N,fill=Habitat_Type)) + geom_point(size=3, alpha=.8,shape=21,position=position_jitter(width=5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=90, vjust=0.5))+scale_fill_manual(values=palette)

ggplot(data, aes(x=Run_Date,y=d15N,fill=SITE_CODE)) + geom_point(size=3, alpha=1,shape=21,position=position_jitter(width=5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=90, vjust=0.5))

```
##Are any samples of suspect quality?  
####Percent N: anything outside of ~9-17% N raises a red flag  
```{r data_QC-N, echo=TRUE}

summary(data$Percent_N)
ggplot(data, aes(x=Percent_N)) + geom_histogram(binwidth=.5, colour="black", fill="blue")+theme_bw()+geom_vline(xintercept=17,linetype="dashed",colour="red")+
  geom_vline(xintercept=9,linetype="dashed",colour="red")

ggplot(data, aes(x=Ordered_SITE,y=Percent_N,fill=Habitat_Type)) + geom_boxplot(colour="black")+theme_bw()+geom_hline(yintercept=9, linetype="dashed",colour="red")+geom_hline(yintercept=17,linetype="dashed",colour="red")+theme(axis.text.x  = element_text(angle=90, vjust=0.5))+scale_fill_manual(values=palette)

#need to take out NAs
data_noNAs<-subset(data,Percent_N!="NA" )
length(which(data_noNAs$Percent_N<9))
length(which(data_noNAs$Percent_N>17))
```

####Percent C: anything outside of ~40-60% C raises a red flag
```{r data_QC-C, echo=TRUE}
summary(data$Percent_C)
ggplot(data, aes(x=Percent_C)) + geom_histogram(binwidth=.5, colour="black", fill="red")+theme_bw()+geom_vline(xintercept=40,linetype="dashed",colour="blue")+
  geom_vline(xintercept=60,linetype="dashed",colour="blue")

ggplot(data, aes(x=Ordered_SITE,y=Percent_C,fill=Habitat_Type)) + geom_boxplot(colour="black")+theme_bw()+geom_hline(yintercept=40, linetype="dashed",colour="blue")+geom_hline(yintercept=60,linetype="dashed",colour="blue")+
theme(axis.text.x  = element_text(angle=90, vjust=0.5))+scale_fill_manual(values=palette)

length(which(data_noNAs$Percent_C<39))
length(which(data_noNAs$Percent_C>61))
```

####Percent C vs. Percent N: are the samples 'bad' values for both?
```{r data_QC-CvN, echo=TRUE}
ggplot(data, aes(y=Percent_C, x=Percent_N,fill=Habitat_Type)) + 
geom_point(size=3, alpha=.8,shape=21,position=position_jitter(width=.5,height=.5)) +theme_bw()+   scale_fill_manual(values=palette)+
  geom_hline(yintercept=60,linetype="dashed",colour="grey10")+
  geom_hline(yintercept=40,linetype="dashed",colour="grey10")+
  geom_vline(xintercept=9,linetype="dashed",colour="grey10")+
  geom_vline(xintercept=17,linetype="dashed",colour="grey10")
```

**need to follow up with Jeff to determine what to do about samples that don't pass the QC criteria?**

##Initial Data exploration for delta C and N  
*Ggplot univariate & bivariate graphic scans etc*
####1. Nitrogen
```{r data_exploration-dN, echo=TRUE}
#Distributions:
ggplot(data, aes(x=d15N)) + 
  geom_histogram(aes(y=..density..),      # Histogram with density on y-axis
                 binwidth=.5,
                 colour="black", fill="dodgerblue") +
  geom_density(alpha=.4, fill="yellow")+theme_bw()+
geom_vline(aes(xintercept=mean(d15N, na.rm=T)),    #Ignore NA values for mean
           color="red", linetype="dashed", size=1)

#density only, faceted:
a<-ggplot(data, aes(x=d15N)) + geom_density(alpha=.4, fill="blue")+theme_bw()+
geom_vline(aes(xintercept=mean(d15N, na.rm=T)),    #Ignore NA values for mean
           color="red", linetype="dashed", size=1)
a+facet_wrap( ~ Ordered_SITE, ncol=4)
#boxplot:
ggplot(data, aes(x=Ordered_SITE, y=d15N, fill=Habitat_Type)) + geom_boxplot() +theme_bw()+
  guides(fill=FALSE)+stat_summary(fun.y=mean, geom="point", shape=5, size=4)+theme(axis.text.x  = element_text(angle=55, vjust=0.5))+scale_fill_manual(values=palette)
#Q-Q plot:
qqnorm(data$d15N)
qqline(data$d15N)#just adding line

#Additional perhaps useful visualizations
#ordering by medians
ggplot(data, aes(x=reorder(Ordered_SITE,d15N), y=d15N, fill=Habitat_Type)) + geom_boxplot() +theme_bw()+xlab("Location (ordered by value)")+
  guides(fill=FALSE)+stat_summary(fun.y=mean, geom="point", shape=5, size=4)+theme(axis.text.x  = element_text(angle=55, vjust=0.5))+scale_fill_manual(values=palette)

stripplot(d15N~Ordered_SITE, data=data, jitter.data=T, group=Habitat_Type, aspect=1, xlab="Location")

#faceted mean dot
ggplot(data_Nsum, aes(y=reorder(Ordered_SITE,N_to_S_ordination), x=mean_d15N, fill=Habitat_Type)) + 
  geom_errorbarh(aes(xmin=mean_d15N-se_d15N,xmax=mean_d15N+se_d15N),size=0.25)+
  geom_point(size=3, aes(colour=Habitat_Type)) +theme_bw()+ guides(fill=FALSE)+
  theme(panel.grid.major.x=element_blank(),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.y=element_line(colour="grey60",linetype="dashed"))+ scale_colour_manual(values=palette,guide=FALSE)+
  ylab("Location (N to S)") +xlab("Mean d15N") +
  facet_grid(Habitat_Type~.,scales="free_y",space="free_y")

ggplot(data,aes(x=SITE_CODE,y=d15N))+geom_boxplot()
ggplot(data,aes(x=SITE_CODE,y=d15N))+geom_boxplot()+facet_grid(Habitat_Type~.)
ggplot(data,aes(x=Habitat_Type,y=d15N))+geom_boxplot()
```

####Carbon
```{r data_exploration-dC, echo=TRUE}
#Distributions:
ggplot(data, aes(x=d13C)) + 
  geom_histogram(aes(y=..density..),      # Histogram with density  on y-axis
                 binwidth=.5,
                 colour="black", fill="blue") +
  geom_density(alpha=.4, fill="yellow")+theme_bw()+
geom_vline(aes(xintercept=mean(d13C, na.rm=T)),    #Ignore NA values for mean
           color="red", linetype="dashed", size=1)

#density only:
a<-ggplot(data, aes(x=d13C)) + geom_density(alpha=.4, fill="blue")+theme_bw()+
geom_vline(aes(xintercept=mean(d13C, na.rm=T)),    #Ignore NA values for mean
           color="red", linetype="dashed", size=1)
a+facet_wrap( ~ Ordered_SITE, ncol=4)
#boxplot:
ggplot(data, aes(x=Ordered_SITE, y=d13C, fill=Habitat_Type)) + geom_boxplot()+theme_bw()+
  guides(fill=FALSE)+stat_summary(fun.y=mean, geom="point", shape=5, size=4)+theme(axis.text.x  = element_text(angle=55, vjust=0.5))+scale_fill_manual(values=palette)
#Q-Q plot:
qqnorm(data$d13C)
qqline(data$d13C)#just adding line

#Additional perhaps useful visualizations
#ordering by medians
ggplot(data, aes(x=reorder(Ordered_SITE,d13C), y=d13C, fill=Habitat_Type)) + geom_boxplot() +theme_bw()+xlab("Location (ordered by value)")+
  guides(fill=FALSE)+stat_summary(fun.y=mean, geom="point", shape=5, size=4)+theme(axis.text.x  = element_text(angle=55, vjust=0.5))+scale_fill_manual(values=palette)

stripplot(d13C~Ordered_SITE, data=data, jitter.data=T, group=Habitat_Type, aspect=1, xlab="Location")

#faceted mean dot
ggplot(data_Csum, aes(y=reorder(Ordered_SITE,N_to_S_ordination), x=mean_d13C, fill=Habitat_Type)) + 
  geom_errorbarh(aes(xmin=mean_d13C-se_d13C,xmax=mean_d13C+se_d13C),size=0.25)+
  geom_point(size=3, aes(colour=Habitat_Type)) +theme_bw()+ guides(fill=FALSE)+
  theme(panel.grid.major.x=element_blank(),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.y=element_line(colour="grey60",linetype="dashed"))+ scale_colour_manual(values=palette,guide=FALSE)+
  ylab("Location (N to S)") +xlab("Mean d13C") +
  facet_grid(Habitat_Type~.,scales="free_y",space="free_y")

ggplot(data,aes(x=SITE_CODE,y=d13C))+geom_boxplot()
ggplot(data,aes(x=SITE_CODE,y=d13C))+geom_boxplot()+facet_grid(Habitat_Type~.)
ggplot(data,aes(x=Habitat_Type,y=d13C))+geom_boxplot()
```
  
####Any relationships/confounding issues with Turtle Size?  
```{r SI_size, echo=TRUE}
ggplot(data,aes(x=SCL,y=CCL))+geom_point()+theme_bw()#duh-but maybe double check the few that are way out there off the line?
sum(!is.na(data$SCL)) 
sum(!is.na(data$CCL))#CCL has fewer missing/NA's, so use this for now
#bunch of missing carapace data, for insular sites, only have 3 sites with carpace data but there are 5 sites according to frequency table below

#issue of big turtles at certain sites?
ggplot(data, aes(x=Ordered_SITE,y=CCL,fill=Habitat_Type)) + geom_boxplot()+theme_bw()+theme(axis.text.x  = element_text(angle=50, vjust=0.5))+scale_fill_manual(values=palette)

ggplot(data, aes(x=Ordered_SITE,y=CCL,fill=Habitat_Type)) + geom_boxplot()+theme_bw()+theme(axis.text.x  = element_text(angle=50, vjust=0.5))+scale_fill_manual(values=palette)+facet_grid(Habitat_Type~.)

#Size vs. Nitrogen
p<-ggplot(data, aes(x=CCL,y=d15N,fill=Habitat_Type)) + geom_point(size=3, alpha=.8,shape=21,position=position_jitter(width=.5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=90, vjust=0.5))+scale_fill_manual(values=palette)
p+geom_smooth(method=lm)

ggplot(data, aes(x=CCL,y=d15N,fill=Ordered_SITE)) + geom_point(size=3, alpha=.8,shape=21,position=position_jitter(width=.5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=90, vjust=0.5))+facet_grid(Habitat_Type~.)

#Size vs. Carbon
p<-ggplot(data, aes(x=CCL,y=d13C,fill=Habitat_Type)) + geom_point(size=3, alpha=.8,shape=21,position=position_jitter(width=.5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=90, vjust=0.5))+scale_fill_manual(values=palette)
p+geom_smooth(method=lm)

ggplot(data, aes(x=CCL,y=d13C,fill=Ordered_SITE)) + geom_point(size=3, alpha=.8,shape=21,position=position_jitter(width=.5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=90, vjust=0.5))

```

```{r CvsN, echo=TRUE}
ggplot(data, aes(x=d15N,y=d13C,fill=Ordered_SITE)) + geom_point(size=3, alpha=.8,shape=21,position=position_jitter(width=.5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=0, vjust=0.5))

ggplot(data, aes(x=d15N,y=d13C,fill=Habitat_Type)) + geom_point(size=3, alpha=.8,shape=21,position=position_jitter(width=.5,height=.5))+theme_bw()+theme(axis.text.x  = element_text(angle=0, vjust=0.5))+scale_fill_manual(values=palette)

CNsum_merge<-merge(data_Csum,data_Nsum)
CNsum_merge$SITENS<-paste(CNsum_merge$N_to_S_ordination, "-",CNsum_merge$Ordered_SITE)
CNsum_merge$SITENS<-factor(CNsum_merge$SITENS,levels= c("1 - MEJ", "2 - PAR" ,"3 - PPE",  "4 - IGN",  "5 - IGZ", "6 - IGD",  "7 - IGE",  "8 - IGP",  "9 - GOR","10 - COC", "11 - DUL", "12 - ISL", "13 - BMA", "14 - IPD","15 - LOR", "16 - LSI", "17 - ESC","18 - CIN", "19 - BLA", "20 - SDB", "21 - SBN", "22 - SGR"))

ggplot(CNsum_merge, aes(x=mean_d13C,y=mean_d15N,fill=Habitat_Type)) +
  geom_errorbar(aes(ymin=mean_d15N-se_d15N,ymax=mean_d15N+se_d15N),size=0.25)+
  geom_errorbarh(aes(xmin=mean_d13C-se_d13C,xmax=mean_d13C+se_d13C),size=0.25)+
  geom_point(size=3, alpha=.9,shape=21)+theme_bw()+theme(axis.text.x  = element_text(angle=0, vjust=0.5))+scale_fill_manual(values=palette)+ylab("Mean d15N per Location")+xlab("Mean d13C per Location")

ggplot(CNsum_merge, aes(x=mean_d13C,y=mean_d15N,fill=SITENS)) +
  geom_errorbar(aes(ymin=mean_d15N-se_d15N,ymax=mean_d15N+se_d15N),size=0.25)+
  geom_errorbarh(aes(xmin=mean_d13C-se_d13C,xmax=mean_d13C+se_d13C),size=0.25)+
  geom_point(size=3, alpha=.9,shape=21)+theme_bw()+theme(axis.text.x  = element_text(angle=0, vjust=0.5))+ylab("Mean d15N per Location")+xlab("Mean d13C per Location")

ggplot(CNsum_merge, aes(x=mean_d13C,y=mean_d15N,fill=SITENS)) +
  geom_errorbar(aes(ymin=mean_d15N-se_d15N,ymax=mean_d15N+se_d15N),size=0.25)+
  geom_errorbarh(aes(xmin=mean_d13C-se_d13C,xmax=mean_d13C+se_d13C),size=0.25)+
  geom_point(size=3, alpha=.9,shape=21)+theme_bw()+theme(axis.text.x  = element_text(angle=0, vjust=0.5))+ylab("Mean d15N per Location")+xlab("Mean d13C per Location")+geom_text(aes(label=Ordered_SITE),hjust=1.5, vjust=0.5,size=3)

ggplot(data, aes(x=d13C,y=d15N,fill=Ordered_SITE)) +
  geom_point(aes(size=CCL), alpha=.9,shape=21)+theme_bw()

```

```{r basic_models, echo=TRUE}
#analysis (don't read into results because some carapace data is missing)
#random effect of site nested within habitat type

#Nitrogen:

mN1<-lmer(data=data2, d15N~Habitat_Type+(1|Habitat_Type/SITE_CODE))      #single Habitat model
mN2<-lmer(data=data2, d15N~CCL+(1|Habitat_Type/SITE_CODE))               #single CCL model
mN3<-lmer(data=data2, d15N~Habitat_Type+CCL+(1|Habitat_Type/SITE_CODE))  #additive model
mN4<-lmer(data=data2, d15N~Habitat_Type*CCL+(1|Habitat_Type/SITE_CODE))  #interactive model
summary(mN1)
summary(mN2)
summary(mN3)
summary(mN4)
#just simple LM-some sites are different? follow up checking df's, etc.
m5<-lm(data=data2, d15N~SITE_CODE)
summary(m5)

#Carbon:
mC1<-lmer(data=data2, d13C~Habitat_Type+(1|Habitat_Type/SITE_CODE))      #single Habitat model
mC2<-lmer(data=data2, d13C~CCL+(1|Habitat_Type/SITE_CODE))               #single CCL model
mC3<-lmer(data=data2, d13C~Habitat_Type+CCL+(1|Habitat_Type/SITE_CODE))  #additive model
mC4<-lmer(data=data2, d13C~Habitat_Type*CCL+(1|Habitat_Type/SITE_CODE))  #interactive model

summary(mC1)
summary(mC2)
summary(mC3)
summary(mC4)

#just simple LM-some sites are different? follow up checking df's, etc.
m5<-lm(data=data2, d13C~SITE_CODE)
summary(m5)
```
